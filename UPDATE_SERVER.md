# Инструкция по обновлению проекта на сервере

## Быстрое обновление (рекомендуется)

Если у вас уже установлен проект на сервере, используйте автоматический скрипт обновления:

```bash
# 1. Подключитесь к серверу
ssh root@otchet.24cybersyndicate.ru
# Пароль: gkzF.t_TRSkR2N

# 2. Перейдите в директорию проекта
cd /var/www/salary-manager

# 3. Сделайте скрипт исполняемым (если еще не сделано)
chmod +x update-server.sh

# 4. Запустите скрипт обновления
./update-server.sh
```

Скрипт автоматически выполнит:
- ✅ Получение обновлений из Git
- ✅ Установку новых зависимостей
- ✅ Генерацию Prisma Client
- ✅ Применение миграций базы данных
- ✅ Сборку проекта
- ✅ Перезапуск приложения через PM2

## Ручное обновление (если скрипт не работает)

Если автоматический скрипт не работает, выполните команды вручную:

```bash
# 1. Подключитесь к серверу
ssh root@otchet.24cybersyndicate.ru
# Пароль: gkzF.t_TRSkR2N

# 2. Перейдите в директорию проекта
cd /var/www/salary-manager

# 3. Получите обновления из репозитория
git pull origin main

# 4. Установите зависимости (если есть новые)
npm install

# 5. Сгенерируйте Prisma Client
npx prisma generate

# 6. Примените миграции базы данных
npx prisma migrate deploy

# 7. Соберите проект
npm run build

# 8. Перезапустите приложение
pm2 restart salary-manager

# 9. Проверьте логи (опционально)
pm2 logs salary-manager --lines 50
```

## Проверка после обновления

После обновления проверьте:

1. **Статус приложения:**
   ```bash
   pm2 status
   ```
   Должен быть статус `online` для `salary-manager`

2. **Логи приложения:**
   ```bash
   pm2 logs salary-manager --lines 50
   ```
   Не должно быть критических ошибок

3. **Доступность сайта:**
   Откройте в браузере: `https://otchet.24cybersyndicate.ru`
   Убедитесь, что сайт загружается корректно

4. **Проверка API:**
   Попробуйте войти в систему и проверить основные функции

## Решение проблем

### Ошибка при git pull

Если возникает конфликт при `git pull`:

```bash
# Сохраните текущие изменения (если нужно)
git stash

# Получите обновления
git pull origin main

# Примените сохраненные изменения (если нужно)
git stash pop
```

### Ошибка при применении миграций

Если миграции не применяются:

```bash
# Проверьте статус миграций
npx prisma migrate status

# Если есть failed миграции, используйте скрипт исправления
chmod +x fix-migrations.sh
./fix-migrations.sh
```

### Ошибка при сборке

Если сборка не проходит:

```bash
# Очистите кэш и пересоберите
rm -rf .next
npm run build
```

### Приложение не запускается

Если PM2 не может запустить приложение:

```bash
# Удалите старое приложение из PM2
pm2 delete salary-manager

# Запустите заново
cd /var/www/salary-manager
pm2 start npm --name "salary-manager" -- start
pm2 save
```

## Полное переразвертывание (если ничего не помогает)

Если обновление не работает и нужно начать с чистого листа:

```bash
# 1. Очистите проект (сохранит .git и .env)
cd /var/www/salary-manager
chmod +x cleanup-project.sh
./cleanup-project.sh

# 2. Запустите полное развертывание
chmod +x deploy-full.sh
./deploy-full.sh
```

⚠️ **Внимание:** Это удалит все файлы проекта (кроме `.git` и `.env`) и пересоздаст всё заново!

## Контакты и поддержка

Если возникли проблемы, проверьте:
- Логи PM2: `pm2 logs salary-manager`
- Логи Nginx: `tail -f /var/log/nginx/error.log`
- Логи PostgreSQL: `tail -f /var/log/postgresql/postgresql-*.log`

