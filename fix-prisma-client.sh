#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Prisma Client
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./fix-prisma-client.sh

set -e

echo "üîß –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma Client..."

cd /var/www/salary-manager

# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ)
echo "‚è∏Ô∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 stop salary-manager 2>/dev/null || true

# 2. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π Prisma Client –ø–æ–ª–Ω–æ—Å—Ç—å—é
echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ Prisma Client..."
rm -rf src/generated/prisma
rm -rf node_modules/.prisma
rm -rf .next

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ö–µ–º—É
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ö–µ–º—ã Prisma..."
if [ ! -f "prisma/schema.prisma" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: prisma/schema.prisma –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –º–æ–¥–µ–ª–∏ LangameSettings –≤ —Å—Ö–µ–º–µ
if ! grep -q "model LangameSettings" prisma/schema.prisma; then
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –º–æ–¥–µ–ª—å LangameSettings –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å—Ö–µ–º–µ"
else
    echo "‚úÖ –ú–æ–¥–µ–ª—å LangameSettings –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å—Ö–µ–º–µ"
fi

# 5. –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Prisma Client –∑–∞–Ω–æ–≤–æ
echo "üî® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma Client..."
npx prisma generate

# 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã
echo "‚úî –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
if [ ! -f "src/generated/prisma/client.ts" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: Prisma Client –Ω–µ –±—ã–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!"
    exit 1
fi

if [ ! -f "src/generated/prisma/models/LangameSettings.ts" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ú–æ–¥–µ–ª—å LangameSettings –Ω–µ –±—ã–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞!"
    exit 1
fi

echo "‚úÖ Prisma Client —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"

# 7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
if npx prisma db pull --schema=prisma/schema.prisma > /dev/null 2>&1; then
    echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î"
    echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ DATABASE_URL –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ .env"
fi

# 8. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
echo "üóÑÔ∏è  –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
npx prisma migrate deploy || echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π"

# 9. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
npm run build

# 10. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 restart salary-manager || pm2 start ecosystem.config.js

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ! Prisma Client –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ"
echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: pm2 logs salary-manager"

